## Ansible

### Упражнения по Ansible

|Name|Topic|Objective & Instructions|Solution|Comments|
|--------|--------|------|----|----|
| Моя первая задача | Задачи | [Упражнение](my_first_task.md) | [Решение](solutions/my_first_task.md)
| Задача обновления и модернизации | Задачи | [Упражнение](update_upgrade_task.md) | [Решение](solutions/update_upgrade_task.md)
| My First Playbook | Playbooks | [Exercise](my_first_playbook.md) | [Solution](solutions/my_first_playbook.md)
  

### Ansible Self Assessment

<details>
<summary>Опишите каждый из следующих компонентов Ansible, включая взаимосвязь между ними:

  * Задание
  * Инвентаризация 
  * Модуль
  * Play
  * Playbook
  * Роль
</summary><br><b>

Задача - обращение к определенному модулю Ansible
Модуль - фактическая единица кода, выполняемая Ansible на вашем собственном или удаленном хосте. Модули индексируются по категориям (база данных, файл, сеть, ...) и также называются плагинами задач.
  
Инвентарь - Файл инвентаря определяет хосты и/или группы хостов, на которых выполняются задачи Ansible. Файл инвентаризации может быть в одном из многих форматов, в зависимости от того, какие плагины инвентаризации у вас установлены. Наиболее распространенными форматами являются INI и YAML.

Воспроизведение - Одна или несколько задач, выполняемых на данном узле (узлах).

Playbook - Одна или несколько пьес. Каждая пьеса может быть выполнена на одном или разных хостах

Роль - роли Ansible позволяют группировать ресурсы на основе определенной функциональности/сервиса таким образом, чтобы их можно было легко использовать повторно. В роли есть каталоги для переменных, значений по умолчанию, файлов, шаблонов, обработчиков, задач и метаданных. Затем вы можете использовать роль, просто указав ее в своем плейбуке.
</b></details>

<details>
<summary>Чем Ansible отличается от других инструментов автоматизации? (например, Chef, Puppet и т.д.)</summary><br><b>

Ansible - это:

* Без агентов
* Минимальные требования к запуску (Python и SSH) и простота в использовании
* Режим по умолчанию - "push" (поддерживается также режим "pull").
* Фокус на простоте и легкости в использовании
</b></details>


<details>
<summary>Правда или ложь? Ansible следует парадигме изменяемой инфраструктуры</summary><br><b>

Верно. При подходе с неизменяемой инфраструктурой вы будете заменять инфраструктуру, а не модифицировать ее.< br>
Ansible скорее следует парадигме изменяемой инфраструктуры, которая позволяет изменять конфигурацию различных компонентов, но этот подход не идеален и имеет свои недостатки, такие как "дрейф конфигурации", когда различные компоненты могут достичь разного состояния по разным причинам.
</b></details>

<details>
<summary>Правда или ложь? Ansible использует декларативный стиль для описания ожидаемого конечного состояния</summary><br><b>

Ложь. В нем используется процедурный стиль.
</b></details>

<details>
<summary>Какую автоматизацию вы бы не стали делать с помощью Ansible и почему? </summary><br><b>

Несмотря на возможность предоставления ресурсов с помощью Ansible, некоторые предпочитают использовать инструменты, которые следуют парадигме неизменяемой инфраструктуры.
Ansible не сохраняет состояние по умолчанию. Поэтому задача, создавшая, например, 5 экземпляров, при повторном выполнении создаст еще 5 экземпляров (за исключением случаев, когда
или предоставлены явные имена), в то время как другие инструменты могут проверить, существует ли 5 экземпляров. Если существует только 4 (например, путем проверки файла состояния), будет создан один дополнительный экземпляр, чтобы достичь конечной цели в 5 экземпляров.
</b></details>

<details>
<summary>Как перечислить все модули и как посмотреть подробности о конкретном модуле?</summary>< br>< br>

1. Онлайн-документы по Ansible
2. `ansible-doc -l` для получения списка модулей и `ansible-doc [имя_модуля]` для получения подробной информации о конкретном модуле
</b></details>

#### Ansible - инвентаризация

<details>
<summary>Что такое файл инвентаризации и как его определить? </summary><br><b>

Файл инвентаризации определяет хосты и/или группы хостов, на которых выполняются задачи Ansible.

Пример файла инвентаризации:

```
192.168.1.2
192.168.1.3
192.168.1.4

[web_servers].
190.40.2.20
190.40.2.21
190.40.2.22
```
</b></details>

<details>
<summary>Что такое динамический инвентарный файл? Когда его можно использовать? </summary>< br>< br>

Файл динамической инвентаризации отслеживает хосты из одного или нескольких источников, таких как облачные провайдеры и системы CMDB.

Вы должны использовать его при использовании внешних источников и особенно, когда хосты в вашей среде автоматически< br>.
запускаются и выключаются, без того, чтобы вы отслеживали каждое изменение в этих источниках.
</b></details>

#### Ansible - Переменные

<details>
<summary> Измените следующую задачу, чтобы вместо значения "zlib" использовалась переменная, а в случае, если переменная не определена, по умолчанию использовалась переменная "zlib".

```
- имя: Установить пакет
  пакет:
    имя: "zlib"
    состояние: настоящее
```
</summary><br><b>

```
- имя: Установить пакет
  пакет:
    name: "{{ имя_пакета|default('zlib') }}".
    состояние: настоящее
```
</b></details>

<details>
<summary>Как сделать переменную "use_var" необязательной?

```
- имя: Установить пакет
  пакет:
    имя: "zlib"
    состояние: настоящее
    использовать: "{{ use_var }}"
```
</summary><br><b>


С "default(omit)"
```
- имя: Установить пакет
  пакет:
    имя: "zlib"
    состояние: настоящее
    использование: "{{ use_var|default(omit) }}".
```
</b></details>

<details>
<summary>Каким будет результат следующей пьесы?</summary><br><b>

```
---
- имя: Печать информации о моем хосте
  хосты: localhost
  gather_facts: 'нет'
  задачи:
      - имя: Печать имени хоста
        отладка:
            msg: "Это я, {{ ansible_hostname }}".
```

Получив написанный код, всегда тщательно проверяйте его. Если ваш ответ: "Это не сработает", то вы правы. Мы используем факт (ansible_hostname), который является собранной информацией с хоста, на котором мы работаем. Но в данном случае мы отключили сбор фактов (gather_facts: no), поэтому переменная будет неопределена, что приведет к ошибке.
</b></details>

<details>
<summary>В этом случае будет использоваться значение '2017': `{{ lookup('env', 'BEST_YEAR') | default('2017', true) }}`?</summary><br><b>

когда переменная окружения 'BEST_YEAR' пуста или ложна.
</b></details>

<details>
<summary>Если значение некоторой переменной равно 1, вы хотите использовать значение "один", в противном случае - "два". Как бы вы это сделали? </summary><br><b>

`{{ (certain_variable == 1) | ternary("one", "two") }}`.
</b></details>

<details>
<summary>Значением некоторой переменной, которую вы используете, является строка "True". Вы бы хотели, чтобы это значение было булевым. Как бы вы привели его? </summary><br><b>

`{{ some_string_var | bool }}`.
</b></details>

<details>
<summary>Вы хотите запускать сборник пьес Ansible только на определенной младшей версии вашей ОС, как вам этого добиться? </summary><br><b>
</b></details>

<details>
<summary>Для чего используется директива "become" в Ansible?</summary><br><b>
</b></details>

<details>
<summary>Что такое факты? Как увидеть все факты об определенном хозяине? </summary><br><b>
</b></details>

<details>
<summary>Каким будет результат выполнения следующего задания? Как это исправить?

```
- хосты: localhost
  задачи:
      - имя: Установить zlib
        пакет:
          имя: zlib
          состояние: настоящее
```
</summary><br><b>
</b></details>

<details>
<summary>С какими передовыми практиками Ansible вы знакомы? Назовите хотя бы три</summary><br><b>
</b></details>

<details>
<summary>Объяснение схемы каталогов роли Ansible</summary><br><b>
</b></details>

<details>
<summary>Для чего используются "блоки" в Ansible? </summary><br><b>
</b></details>

<details>
<summary>Как вы обрабатываете ошибки в Ansible? </summary><br><b>
</b></details>

<details>
<summary>Вы хотите запускать определенную команду, если задание не выполняется. Как этого добиться? </summary><br><b>
</b></details>

<details>
<summary>Напишите playbook для установки 'zlib' и 'vim' на всех хостах, если файл '/tmp/mario' существует в системе.</summary><br><b>

```
---
- хозяева: все
  вары:
      mario_file: /tmp/mario
      список_пакетов:
          - 'zlib'
          - 'vim'
  задачи:
      - имя: Проверка наличия файла mario
        стат:
            путь: "{{ mario_file }}".
        регистр: mario_f

      - имя: Установить zlib и vim, если существует файл mario
        стать: "да"
        пакет:
            name: "{{ item }}"
            состояние: настоящее
        with_items: "{{ список_пакетов }}"
        когда: mario_f.stat.exists
```
</b></details>

<details>
<summary>Напишите одну задачу, которая проверяет, что все файлы в переменной files_list существуют на хосте</summary><br><b>

```
- имя: Убедитесь, что все файлы существуют
  утверждать:
    это:
      - item.stat.exists
  цикл: "{{ список_файлов }}"
```
</b></details>

<details>
<summary>Напишите playbook для развертывания файла '/tmp/system_info' на всех хостах, кроме группы контроллеров, со следующим содержимым</summary><br><b>

  ```
  Я <HOSTNAME> и моя операционная система - <OS>
  ```

  Замените < HOSTNAME> и < OS> фактическими данными для конкретного узла, на котором вы работаете

Книга воспроизведения для развертывания файла system_info

```
---
- имя: Развернуть файл /tmp/system_info
  хосты: все:!контроллеры
  задачи:
      - имя: Развернуть /tmp/system_info
        шаблон:
            src: system_info.j2
            dest: /tmp/system_info
```

Содержание шаблона system_info.j2

```
# {{ ansible_managed }}
Я {{ ansible_hostname }} и моя операционная система {{ ansible_distribution }}.
```
</b></details>

<details>
<summary>Переменная 'whoami' определена в следующих местах:

  * роль по умолчанию -> whoami: mario
  * дополнительные vars (переменные, которые вы передаете в Ansible CLI с помощью -e) -> whoami: toad
  * факты о хостах -> whoami: luigi
  * переменные инвентаря (неважно, какого типа) -> whoami: browser

В соответствии с приоритетом переменной, какая из них будет использоваться?</summary><br><b>

Правильный ответ - "жаба".

Приоритет переменных - это то, как переменные отменяют друг друга, когда они установлены в разных местах. Если вы не сталкивались с этим до сих пор, то наверняка столкнетесь в какой-то момент, что делает эту тему полезной для понимания.

В контексте нашего вопроса, порядок будет следующим: дополнительные переменные (всегда переопределяют любую другую переменную) -> факты хоста -> переменные инвентаря -> роли по умолчанию (самые слабые).

Ниже приведен порядок приоритетов от наименьшего к наибольшему (последние перечисленные переменные выигрывают в приоритетности):

1. значения командной строки (например, "-u user")
2. роль по умолчанию [[1\]](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#id15)
3. файл инвентаризации или группа скриптов vars [[2\]](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#id16)
4. инвентаризация group_vars/all [[3\]](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#id17)
5. playbook group_vars/all [[3\]](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#id17)
6. инвентаризация group_vars/* [[3\]](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#id17)
7. playbook group_vars/* [[3\]](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#id17)
8. файл инвентаризации или скрипт host vars [[2\]](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#id16)
9. инвентаризация host_vars/* [[3\]](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#id17)
10. playbook host_vars/* [[3\]](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#id17)
11. host facts / cached set_facts [[4\]](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#id18)
12. игровые вары
13. воспроизвести vars_prompt
14. воспроизвести vars_files
15. параметры роли (определяются в файле role/vars/main.yml)
16. переменные блока (только для задач в блоке)
17. переменные задачи (только для задачи)
18. include_vars
19. set_facts / registered vars
20. параметры роли (и include_role)
21. включать параметры
22. дополнительные параметры (всегда имеют приоритет)

Полный список можно найти в [PlayBook Variables](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#ansible-variable-precedence) . Также обратите внимание, что существует значительная разница между Ansible 1.x и 2.x.
</b></details>

<details>
< резюме> Для каждого из следующих утверждений определите, является ли оно истинным или ложным:

  * Модуль - это набор задач
  * Лучше использовать оболочку или команду вместо конкретного модуля
  * Факты хозяина переопределяют переменные игры
  * Роль может включать в себя следующее: vars, meta и обработчики.
  * Динамическая инвентаризация создается путем извлечения информации из внешних источников
  * Лучше всего использовать отступ в 2 пробела вместо 4.
  * 'notify' используется для запуска обработчиков
  * Этот "hosts: all:!controllers" означает 'запускать только на хостах группы контроллеров</summary><br><b>
</b></details>

<details>
<summary>Объясните разницу между вилками и серией и дросселем.</summary><br><b>

`Serial` - это как запуск плейбука для каждого хоста по очереди, ожидая завершения всего плейбука перед переходом к следующему хосту. `forks`=1 означает запуск первой задачи в пьесе на одном хосте перед запуском той же задачи на следующем хосте, так что первая задача будет запущена на каждом хосте, прежде чем будет затронута следующая задача. По умолчанию в ansible значение fork равно 5.

```
[по умолчанию]
вилы = 30
```

```
- хосты: веб-серверы
  серийный: 1
  задачи:
    - имя: ...
```

Ansible также поддерживает `throttle` Это ключевое слово ограничивает количество рабочих до максимума, установленного через настройку forks или serial. Это может быть полезно при ограничении задач, которые могут требовать большого количества процессора или взаимодействовать с API с ограничением скорости.

```
задачи:
- команда: /path/to/cpu_intensive_command
  дроссель: 1
```

</b></details>

<details>
<summary>Что такое ansible-pull? Чем он отличается от работы ansible-playbook? </summary><br><b>
</b></details>

<details>
<summary>Что такое Ansible Vault? </summary><br><b>
</b></details>

<details>
< резюме> Продемонстрируйте каждое из следующих действий с помощью Ansible:

  * Условия
  * Петли
</summary><br><b>
</b></details>

<details>
<summary>Что такое фильтры? Есть ли у вас опыт написания фильтров? </summary><br><b>
</b></details>

<details>
<summary>Напишите фильтр для капитализации строки</summary><br><b>

```
def cap(self, string):
    return string.capitalize()
```
</b></details>

<details>
<summary>Вы хотите запускать задачу только в том случае, если предыдущая задача что-то изменила. Как этого добиться? </summary><br><b>
</b></details>

<details>
<summary>Что такое плагины обратного вызова? Чего можно достичь с помощью плагинов обратного вызова? </summary><br><b>
</b></details>

<details>
<summary>Что такое Ansible Collections? </summary><br><b>
</b></details>

<details>
<summary>В чем разница между `include_task` и `import_task`? </summary><br><b>
</b></details>

<details>
< резюме> Файл '/tmp/exercise' включает следующее содержимое

```
Гоку = 9001
Вегета = 5200
Транки = 6000
Готенкс = 32
```

С одним заданием переключите содержание на:

```
Гоку = 9001
Вегета = 250
Магистрали = 40
Готенкс = 32
```
</summary><br><b>

```
- название: Изменить уровни саянов
  lineinfile:
    dest: /tmp/exercise
    regexp: "{{ item.regexp }}".
    строка: "{{ item.line }}"
  с_предметами:
    - { regexp: '^Vegeta', line: 'Vegeta = 250' }
    - { regexp: '^Trunks', line: 'Trunks = 40' }
    ...
```
</b></details>


#### Ansible - исполнение и стратегия

<details>
<summary>Правда или ложь? По умолчанию Ansible будет выполнять все задачи на одном хосте, прежде чем переходить к следующему хосту</summary><br><b>

Ложь. Ansible выполнит одну задачу на всех хостах перед переходом к следующей задаче в пьесе. На сегодняшний день по умолчанию используется 5 форков.< br>.
В Ansible это поведение описывается как "стратегия", и его можно настраивать.
</b></details>

<details>
<summary>Что такое "стратегия" в Ansible? Что такое стратегия по умолчанию? </summary><br><b>

Стратегия в Ansible описывает, как Ansible будет выполнять различные задачи на хостах. По умолчанию Ansible использует "Линейную стратегию", которая определяет, что каждая задача будет выполняться на всех хостах, прежде чем переходить к следующей задаче.
</b></details>

<details>
<summary>Какие стратегии Ansible вам знакомы? </summary><br><b>

  - Линейная: стратегия по умолчанию в Ansible. Выполните каждое задание на всех хостах, прежде чем продолжить.
  - Бесплатно: Для каждого ведущего выполните все задания до конца пьесы как можно быстрее
  - Отладка: Выполнение заданий в интерактивном режиме
</b></details>

<details>
<summary>Для чего используется ключевое слово < code>serial</code>? </summary><br><b>

Используется для указания количества (или процента) хостов, на которых будет запущена полная версия игры, перед переходом к следующему количеству хостов в группе.

Например:
```
- название: Некоторая игра
  хосты: базы данных
  серийный: 4
```

Если у вашей группы 8 хостов. Он запустит всю пьесу на 4 хостах, а затем ту же пьесу на других 4 хостах.
</b></details>

#### Тестирование Ansible

<details>
<summary>Как вы тестируете свои проекты на базе Ansible? </summary><br><b>
</b></details>

<details>
<summary>Что такое молекула? Как она работает? </summary><br><b>
</b></details>

<details>
<summary>Вы запускаете тесты Ansible и получаете сообщение "idempotence test failed". Что это значит? Почему idempotence важна? </summary><br><b>
</b></details>

#### Ansible - Отладка

<details>
<summary>Как узнать тип данных определенной переменной в одном из плейбуков?</summary><br><b>

"{{ some_var | type_debug }}".
</b></details>

#### Ansible - Коллекции

<details>
<summary>Что такое коллекции в Ansible? </summary><br><b>
</b></details>

